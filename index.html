<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NSO Quiz Competition</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f5;
      margin: 0;
      padding: 20px;
    }
    .handwriting {
      font-family: Arial, sans-serif;
      font-size: 24px;
      text-align: center;
      margin-top: 30px;
      color: #1e293b;
    }
    h2 {
      text-align: center;
      color: #1e3a8a;
    }
    #registrationForm, #quizSection, #certificate {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }
    #captcha {
      font-family: 'Courier New', monospace;
      font-size: 22px;
      font-weight: bold;
      background: #e0e7ff;
      text-align: center;
      letter-spacing: 5px;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 15px;
    }
    #timer {
      font-weight: bold;
      text-align: right;
      color: #dc2626;
      margin-bottom: 10px;
    }
    .btn {
      background-color: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #1d4ed8;
    }
  </style>
</head>
<body>

<h2>National Statistics Office Quiz Competition</h2>

<div id="registrationForm">
  <input type="text" id="name" placeholder="Enter your full name" required>
  <input type="text" id="college" placeholder="Enter your college name" required>
  <input type="text" id="Mobile" placeholder="Enter your Mobile Number" required>
  <div id="captcha"></div>
  <input type="text" id="captchaInput" placeholder="Enter captcha">
  <button class="btn" onclick="startQuiz()">Start Quiz</button>
</div>

<div id="quizSection" style="display: none;">
  <div id="timer"></div>
  <div id="questionBox"></div>
  <button class="btn" onclick="nextQuestion()">Next</button>
</div>

<div id="certificate" style="display: none;">
  <p id="resultText" class="handwriting"></p>
  <button class="btn" onclick="generateCertificate()">Download Certificate</button>
</div>

<script>
  const questions = [
    { question: "What is the primary function of the Field Operations Division within the NSO?", options: ["Policy formulation", "Data collection for large-scale surveys", "Data analysis", "Report writing"], answer: 1 },
    { question: "Which ministry oversees the NSO in India?", options: ["Ministry of Finance", "Ministry of Home Affairs", "MoSPI", "Ministry of Planning"], answer: 2 }
  ];

  let currentQuestion = 0, score = 0, timer, countdown = 20, captchaValue = '';

  function generateCaptcha() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    captchaValue = '';
    for (let i = 0; i < 4; i++) {
      captchaValue += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById("captcha").innerText = captchaValue;
  }

  function startQuiz() {
    const inputCaptcha = document.getElementById("captchaInput").value.trim();
    if (inputCaptcha !== captchaValue) {
      alert("Incorrect CAPTCHA. Try again.");
      generateCaptcha();
      return;
    }
    document.getElementById("registrationForm").style.display = "none";
    document.getElementById("quizSection").style.display = "block";
    showQuestion();
  }

  function showQuestion() {
    if (currentQuestion >= questions.length) {
      document.getElementById("quizSection").style.display = "none";
      document.getElementById("certificate").style.display = "block";

      const name = document.getElementById("name").value;
      const college = document.getElementById("college").value;
      const mobile = document.getElementById("Mobile").value;

      const text = score >= questions.length / 2
        ? `This is to certify that ${name} from ${college} has successfully completed the NSO Quiz Competition, scoring ${score} out of ${questions.length}.`
        : `This is to certify that ${name} from ${college} participated in the NSO Quiz Competition, scoring ${score} out of ${questions.length}.`;

      document.getElementById("resultText").innerText = text;
      sendDataToGoogleSheet(name, college, mobile, score);
      return;
    }

    countdown = 20;
    document.getElementById("timer").innerText = `Time: ${countdown}s`;

    const q = questions[currentQuestion];
    let html = `<p><strong>${currentQuestion + 1}. ${q.question}</strong></p>`;
    q.options.forEach((opt, idx) => {
      html += `<label><input type="radio" name="option" value="${idx}"> ${String.fromCharCode(65 + idx)}. ${opt}</label><br>`;
    });
    document.getElementById("questionBox").innerHTML = html;

    timer = setInterval(() => {
      countdown--;
      document.getElementById("timer").innerText = `Time: ${countdown}s`;
      if (countdown <= 0) {
        clearInterval(timer);
        nextQuestion();
      }
    }, 1000);
  }

  function nextQuestion() {
    clearInterval(timer);
    const selected = document.querySelector('input[name="option"]:checked');
    if (selected && parseInt(selected.value) === questions[currentQuestion].answer) score++;
    currentQuestion++;
    showQuestion();
  }

  function sendDataToGoogleSheet(name, college, mobile, score) {
    const endpoint = "https://script.google.com/macros/s/AKfycbyubN1llle9ThG4aGjK4qvI7YaAwMh2E4ubu8CSh7GWC_uR0awiiHxruR-2iZYu6nGe0Q/exec";
    const data = { name, college, mobile, score };

    fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(response => response.text())
    .then(result => {
      console.log("Google Sheet response:", result);
      alert("Details recorded to Google Sheet!");
    })
    .catch(error => {
      console.error("Error:", error);
      alert("Failed to send data to Google Sheet. Check script URL or deployment settings.");
    });
  }

  function generateCertificate() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape" });
    const name = document.getElementById("name").value;
    const college = document.getElementById("college").value;
    const text = document.getElementById("resultText").innerText;

    doc.setFillColor(240, 248, 255);
    doc.rect(0, 0, 297, 210, 'F');
    doc.setFontSize(26);
    doc.setTextColor(0, 0, 102);
    doc.text("Certificate of Participation", 148, 40, null, null, "center");
    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text(text, 148, 80, null, null, "center");
    doc.setFontSize(12);
    doc.setTextColor(100);
    doc.text("Issued by: National Statistics Office", 148, 130, null, null, "center");
    doc.text("Date: " + new Date().toLocaleDateString(), 148, 140, null, null, "center");

    doc.save(`${name}_NSO_Certificate.pdf`);
  }

  window.onload = generateCaptcha;
</script>

</body>
</html>
